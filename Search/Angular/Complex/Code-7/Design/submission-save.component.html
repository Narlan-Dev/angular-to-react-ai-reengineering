<div class="page-wrapper">
  <div class="page-breadcrumb">
    <div class="row">
      <div class="col-12 d-flex no-block align-items-center">
        <h4 class="page-title">Submissões</h4>
      </div>
    </div>
  </div>
  <div *ngIf="!loading; else loadingBlock" class="container-fluid">
    <div class="card">
      <form
        [formGroup]="submissionForm"
        (ngSubmit)="onSubmit()"
        class="form-horizontal"
      >
        <div class="card-body">
          <h4 class="card-title">
            Submeter trabalho para a trilha {{ track ? track.name : "" }}
          </h4>
          <div class="form-group row">
            <label
              for="title"
              class="col-sm-3 text-right control-label col-form-label"
              >Título</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                class="form-control"
                id="title"
                name="title"
                formControlName="title"
                placeholder="Título do seu trabalho"
                [ngClass]="{ 'is-invalid': submitted && f.title.errors }"
              />
              <div *ngIf="submitted && f.title.errors" class="invalid-feedback">
                <div *ngIf="f.title.errors.required">
                  Necessário informar o título do trabalho
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!fullTrackFormat" class="form-group row">
            <label
              for="abstract"
              class="col-sm-3 text-right control-label col-form-label"
              >Resumo</label
            >
            <div class="col-sm-9">
              <ngx-editor-menu
                [editor]="editorConfig"
                [toolbar]="toolbar"
              ></ngx-editor-menu>
              <ngx-editor
                [editor]="editorConfig"
                name="abstract"
                (ngModelChange)="wordCounter()"
                formControlName="abstract"
                height="400px"
              >
              </ngx-editor>
              <div class="col-12">
                <span class="float-right"
                  >Total: {{ words }}
                  {{ words > 1 ? "palavras" : "palavra" }}</span
                >
              </div>
            </div>
          </div>

          <div class="form-group row" *ngIf="fullTrackFormat && !fileExists">
            <label
              for="keywords"
              class="col-sm-3 text-right control-label col-form-label"
              >Arquivo da submissão</label
            >
            <div class="col-sm-9">
              <input
                type="file"
                class="form-control"
                id="submissionFile"
                name="submissionFile"
                (change)="onSubmissionFileChange($event)"
                accept="application/pdf"
                [ngClass]="{
                  'is-invalid': submitted && f.submissionFile.errors
                }"
              />
              <div
                *ngIf="submitted && f.submissionFile.errors"
                class="invalid-feedback"
              >
                <div>Necessário anexar o arquivo (PDF) da submissão.</div>
              </div>
              <a
                [href]="track.submissionInstructionsLink"
                target="_blank"
                class="mt-3"
                *ngIf="
                  track.submissionInstructionsLink && track.format == 'full'
                "
              >
                Instruções para submissão
              </a>
            </div>
          </div>

          <div class="form-group row" *ngIf="fileExists">
            <label
              for="keywords"
              class="col-sm-3 text-right align-middle control-label col-form-label"
              >Arquivo da submissão</label
            >
            <div class="col-sm-9 row">
              <div class="col-sm-3">
                <button
                  type="button"
                  class="btn btn-success"
                  type="button"
                  (click)="downloadSubmissionFile(submission)"
                >
                  Download
                </button>
              </div>
              <div class="col-sm-3">
                <button
                  type="button"
                  class="btn btn-danger"
                  type="button"
                  (click)="changeSubmissionFile()"
                >
                  Substituir arquivo da submissão
                </button>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label
              for="keywords"
              class="col-sm-3 text-right control-label col-form-label"
              >Palavras-chave</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                class="form-control"
                id="keywords"
                name="keywords"
                formControlName="keywords"
                placeholder="Palavras-chave separadas por vírgula ( , )"
                [ngClass]="{ 'is-invalid': submitted && f.keywords.errors }"
              />
              <div
                *ngIf="submitted && f.keywords.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.keywords.errors.required">
                  Informe pelo menos uma palavra-chave
                </div>
                <div *ngIf="f.keywords.errors.lessThanOne">
                  Informe pelo menos uma palavra-chave
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label
              for="authors"
              class="col-sm-3 text-right control-label col-form-label"
              >Autores</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                class="form-control"
                id="authors"
                name="authors"
                formControlName="authors"
                placeholder="Autores separados por vírgula ( , )"
                [ngClass]="{ 'is-invalid': submitted && f.authors.errors }"
              />
              <div
                *ngIf="submitted && f.authors.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.authors.errors.required">
                  Informe pelo menos um autor
                </div>
                <div *ngIf="f.authors.errors.lessThanOne">
                  Informe pelo menos um autor
                </div>
                <div *ngIf="f.authors.errors.containsPoint">
                  Não são permitidas abreviações nos nomes dos autores
                </div>
              </div>
            </div>
          </div>

          <div class="form-group row">
            <label
              class="col-sm-3 text-right control-label col-form-label"
            ></label>
            <div class="col-sm-9">
              <div class="custom-control custom-checkbox">
                <input
                  type="checkbox"
                  class="custom-control-input"
                  id="extensive_yes"
                  name="extensive"
                  [value]="false"
                  formControlName="extensive"
                  [ngClass]="{ 'is-invalid': submitted && f.extensive.errors }"
                />
                <label class="custom-control-label" for="extensive_yes">
                  Afirmo que os nomes de todos os autores acima citados estão
                  escritos por extenso e não possuem abreviações
                </label>
                <div
                  *ngIf="submitted && f.extensive.errors"
                  class="invalid-feedback"
                >
                  <div *ngIf="f.extensive.errors.required">
                    Você deve confirmar que os nomes de todos os autores estão
                    escritos por extenso
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group row">
            <label
              for="knowledge_area"
              class="col-sm-3 text-right control-label col-form-label"
              >Área</label
            >
            <div class="col-sm-9">
              <!-- <input type="text" (ngModelChange)="filterItem($event)" [(ngModel)]="filterText">
              <br>
              <select
                class="select2 form-control select2-hidden-accessible font-big"
                style="width: 100%; height: 36px"
                aria-hidden="true"
                name="knowledge_area"
                formControlName="knowledge_area"
                [(ngModel)]="selectKnowledgeArea"
                (ngModelChange)="onChangeOfOptions($event)"
                [ngClass]="{
                  'is-invalid': submitted && f.knowledge_area.errors
                }"
              >
                <option [ngValue]="null"></option>
                <option *ngFor="let area of areas" [ngValue]="area">
                  {{ area.area + " - " + area.sub_area }}
                </option>
              </select> -->

              <ng-multiselect-dropdown
                class="form-control"
                name="knowledge_area"
                formControlName="knowledge_area"
                [ngClass]="{
                  'is-invalid': submitted && f.knowledge_area.errors
                }"
                [placeholder]="'Selecione a área de conhecimento'"
                [settings]="dropdownSettings"
                [data]="dropdownList"
                [(ngModel)]="selectedItems"
              >
              </ng-multiselect-dropdown>
              <div
                *ngIf="submitted && f.knowledge_area.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.knowledge_area.errors.required">
                  Informe a área de conhecimento
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="track && track.submissionCategory" class="form-group row">
            <label
              for="category"
              class="col-sm-3 text-right control-label col-form-label"
              >{{ track.submissionCategory }}</label
            >
            <div class="col-sm-9">
              <select
                class="select2 form-control select2-hidden-accessible font-big"
                style="width: 100%; height: 36px"
                aria-hidden="true"
                name="category"
                formControlName="category"
                [ngClass]="{ 'is-invalid': submitted && f.category.errors }"
              >
                <option [ngValue]="null"></option>
                <option
                  *ngFor="let categoryValue of track.submissionCategoryValues"
                  [ngValue]="categoryValue"
                >
                  {{ categoryValue }}
                </option>
              </select>
              <div
                *ngIf="submitted && f.category.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.category.errors.required">
                  {{ track.submissionCategory }} é uma informação obrigatória
                </div>
              </div>
            </div>
          </div>
          <!--
          <div class="form-group row">
            <label
              for="presentation"
              class="col-sm-3 text-right control-label col-form-label"
              >Apresentação</label
            >
            <div class="col-sm-9">
              <select
                class="select2 form-control select2-hidden-accessible font-big"
                style="width: 100%; height: 36px"
                aria-hidden="true"
                name="presentation"
                formControlName="presentation"
                [ngClass]="{ 'is-invalid': submitted && f.presentation.errors }"
              >
                <option [ngValue]="null"></option>
                <option *ngFor="let p of presentationTypes" [ngValue]="p">
                  {{ p }}
                </option>
              </select>
              <div
                *ngIf="submitted && f.presentation.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.presentation.errors.required">
                  Informe o tipo de apresentação
                </div>
              </div>
            </div>
          </div>
          -->
          <div
            class="form-group row"
            *ngIf="
              track &&
              track.advisorReviewRequired &&
              (!editByAdvisor || requestAdvisorCpf)
            "
          >
            <label
              for="institution"
              class="col-sm-3 text-right control-label col-form-label"
              >CPF do orientador</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                maxlength="11"
                class="form-control"
                placeholder="CPF do orientador (apenas números)"
                id="advisor"
                name="advisor"
                formControlName="advisor"
                [ngClass]="{ 'is-invalid': submitted && f.advisor.errors }"
                (keypress)="allowOnlyNumbers($event)"
              />
              <div
                *ngIf="submitted && f.advisor.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.advisor.errors.required">
                  Necessário informar o CPF do orientador
                </div>
                <div
                  *ngIf="
                    f.advisor.errors.cpfvalidator &&
                    (f.advisor.dirty || f.advisor.touched)
                  "
                >
                  CPF inválido
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row" *ngIf="requestEmail && !editByAdvisor">
            <label
              for="institution"
              class="col-sm-3 text-right control-label col-form-label"
              >E-mail do orientador</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                class="form-control"
                placeholder="Email do orientador"
                id="advisorEmail"
                name="advisorEmail"
                formControlName="advisorEmail"
                [ngClass]="{ 'is-invalid': submitted && f.advisorEmail.errors }"
              />
              <div
                *ngIf="submitted && f.advisorEmail.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.advisorEmail.errors.required">
                  Necessário informar o e-mail do orientador
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label
              for="institution"
              class="col-sm-3 text-right control-label col-form-label"
              >Instituição</label
            >
            <div class="col-sm-9">
              <input
                type="text"
                class="form-control"
                placeholder="Instituição a qual está vinculado"
                id="institution"
                name="institution"
                formControlName="institution"
                [ngClass]="{ 'is-invalid': submitted && f.institution.errors }"
              />
              <div
                *ngIf="submitted && f.institution.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.institution.errors.required">
                  Necessário informar instituição a qual você está vinculado
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label
              for="center"
              class="col-sm-3 text-right control-label col-form-label"
              >Centro de ensino</label
            >
            <div class="col-sm-9">
              <select
                class="select2 form-control select2-hidden-accessible font-big"
                style="width: 100%; height: 36px"
                aria-hidden="true"
                name="center"
                formControlName="center"
              >
                <option [ngValue]="null">Não se aplica</option>
                <option *ngFor="let ce of centers" [ngValue]="ce">
                  {{ ce }}
                </option>
              </select>
            </div>
          </div>
          <div
            *ngIf="track && track.additionalQuestionAuthor && !editByAdvisor"
            class="form-group row align-items-center"
          >
            <label
              for="approved"
              class="col-sm-3 text-right control-label col-form-label"
              >{{ track.additionalQuestionAuthor }}</label
            >
            <div id="approved" class="col-sm-9">
              <div class="row justify-content-start align-items-center">
                <div class="h-padding">Não</div>
                <mat-slide-toggle
                  id="additionalQuestionAnswer"
                  formControlName="additionalQuestionAnswer"
                  class="tp-margin"
                  [checked]="f.additionalQuestionAnswer.value"
                >
                </mat-slide-toggle>
                <div class="h-padding">Sim</div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label
              for="supporting_source"
              class="col-sm-3 text-right control-label col-form-label"
              >Fonte de financiamento</label
            >
            <div class="col-sm-9">
              <select
                class="select2 form-control select2-hidden-accessible font-big"
                style="width: 100%; height: 36px"
                aria-hidden="true"
                name="supporting_source"
                formControlName="supporting_source"
                [ngClass]="{
                  'is-invalid': submitted && f.supporting_source.errors
                }"
              >
                <option [ngValue]="null"></option>
                <option
                  *ngFor="let source of supportingSources"
                  [ngValue]="source"
                >
                  {{ source }}
                </option>
              </select>
              <div
                *ngIf="submitted && f.supporting_source.errors"
                class="invalid-feedback"
              >
                <div *ngIf="f.supporting_source.errors.required">
                  Informe a fonte de financiamento
                </div>
              </div>
            </div>
          </div>
          <div
            *ngIf="
              event &&
              event.supporting_institution_message_instructions &&
              event.supporting_institution_message_instructions.length > 4 &&
              f.supporting_source.value &&
              f.supporting_source.value !== 'Não se aplica'
            "
            class="form-group row"
          >
            <label
              for="supporting_institution_message"
              class="col-sm-3 text-right control-label col-form-label"
            ></label>
            <div class="col-sm-9">
              <label class="col-sm-12"
                >Instruções para preenchimento do texto no campo Apoio
                (abaixo):</label
              >
              <div
                class="col-sm-12"
                [innerHtml]="event.supporting_institution_message_instructions"
              ></div>
            </div>
          </div>
          <div
            *ngIf="
              f.supporting_source.value &&
              f.supporting_source.value !== 'Sem financiamento'
            "
            class="form-group row"
          >
            <label
              for="supporting_institution_message"
              class="col-sm-3 text-right control-label col-form-label"
              >Mensagem de apoio</label
            >
            <div class="col-sm-9">
              <textarea
                rows="3"
                class="form-control"
                id="supporting_institution_message"
                placeholder="Mensagem de apoio exigida pelo órgão de fomento ou instituição financiadora"
                name="supporting_institution_message"
                formControlName="supporting_institution_message"
              ></textarea>
            </div>
          </div>
          <app-question-main
            #questionsForm
            *ngIf="questions && questions.length > 0"
            [questions]="questions"
            [submitted]="submitted"
            formControlName="questions"
          >
          </app-question-main>
          <div
            *ngIf="event && event.virtual && !editByAdvisor"
            class="form-group row"
            style="margin-bottom: 0"
          >
            <div class="col-sm-3">
              <input
                type="checkbox"
                id="acceptVirtualEventStatement"
                id="acceptVirtualEventStatement"
                name="acceptVirtualEventStatement"
                formControlName="acceptVirtualEventStatement"
                [checked]="f.acceptVirtualEventStatement.value"
                [ngClass]="{
                  'is-invalid':
                    submitted && f.acceptVirtualEventStatement.errors
                }"
                style="float: right; margin-top: 10px"
              />
            </div>
            <label class="col-sm-9" for="acceptVirtualEventStatement">{{
              virtualEventStatement
            }}</label>
          </div>
          <div
            class="form-group row justify-content-end"
            *ngIf="submitted && f.acceptVirtualEventStatement.errors"
          >
            <span
              *ngIf="f.acceptVirtualEventStatement.errors.required"
              style="font-size: 80%; color: #da542e; margin-right: 20px"
              >Você deve concordar com a declaração acima para finalizar a
              submissão</span
            >
          </div>
          <div class="form-group row text-center" style="margin-top: 15px">
            <strong>
              ATENÇÃO: verifique atenciosamente as informações desta submissão e
              também os dados cadastrais da sua conta (especialmente o seu nome
              completo), pois serão utilizados na geração de certificado e
              outras finalidades.
            </strong>
          </div>
          <div
            *ngIf="isEdit && track?.advisorReviewRequired"
            class="form-group row"
          >
            <label
              for="comment"
              class="col-sm-3 text-right control-label col-form-label"
              >Novo comentário</label
            >
            <div class="col-sm-9">
              <textarea
                type="text"
                class="form-control"
                id="comment"
                placeholder="Insira aqui um comentário"
                [(ngModel)]="comment"
                [ngModelOptions]="{ standalone: true }"
              ></textarea>
            </div>
          </div>
          <div
            *ngIf="isEdit && track?.advisorReviewRequired"
            class="row justify-content-end"
          >
            <div class="col-sm-9">
              <h6>Comentários:</h6>
              <div
                class="border rounded-5 mt-2 justify-content-center"
                style="
                  overflow-y: auto;
                  height: 250px;
                  border-radius: 3px;
                  border-color: #e9ecef;
                "
              >
                <div
                  *ngFor="let c of submission.submissionComments"
                  class="card bg-light mb-2"
                  style="margin: 7px"
                >
                  <div class="card-header">
                    <strong class="mr-1">{{ c.author }} </strong> em
                    {{ c.date }}
                  </div>
                  <div class="card-body">
                    <p class="card-text">
                      {{ c.message }}
                    </p>
                  </div>
                </div>
                <p
                  class="mt-3 ml-3"
                  *ngIf="!loading && submission.submissionComments?.length == 0"
                >
                  Nenhum comentário cadastrado.
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="border-top">
          <div class="card-body">
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="
                !(submission?.advisorState !== 'advisor_feedback_approved') &&
                editByAdvisor
              "
            >
              {{ editByAdvisor ? "Liberar para revisão do evento" : "Salvar" }}
            </button>
            <a
              *ngIf="
                submission?.advisorState !== 'advisor_feedback_approved' &&
                editByAdvisor
              "
              (click)="addSubmissionComment()"
              class="btn btn-danger text-white ml-2"
              >Solicitar correção pelo autor</a
            >
          </div>
        </div>
      </form>
    </div>
  </div>
  <ng-template #loadingBlock>
    <mat-progress-spinner [diameter]="40" color="primary" mode="indeterminate">
    </mat-progress-spinner>
  </ng-template>
</div>
